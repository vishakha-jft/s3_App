<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <title>S3</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    .image {
      max-width: 300px;
      margin: 10px;
    }
  </style>
</head>
<body>
<h2> S3 - APP (Image Uploader )</h2>
<div class="container" style="background-color: #fff;margin-top: 5rem;border-radius: 2%">
  <h3>Choose your Folder</h3>
  <form id="folderForm">
    <div class="md-form mb-5 d-flex justify-content-around">
      <i class="fas fa-tag prefix grey-text"></i>
      <div class="w-75">
        <input type="hidden" id="bucketName" name="bucketName">
        <input type="hidden" id="pathName" name="pathName">
        <input type="text" id="folderName" name="folderName" class="form-control validate">
        <label data-error="wrong" data-success="right" for="folderName">your Folder Name</label>
      </div>
    </div>
    <div class="text-center mt-4">
      <button class="btn btn-info mt-1" onclick="createFolder()">Create<i class="fas fa-sign-in ml-1"></i></button>
    </div>
  </form>
  <table class="table table-striped table-bordered" style="margin-bottom: 3rem" >
    <thead class="table-dark">
    <tr>
      <th scope="col">S.No.</th>
      <th scope="col">Folder Name</th>
      <th scope="col">Action</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="folder,folderIndex: ${folderList}">
      <th th:text="${folderIndex.index}"></th>
      <td th:text="${folder}"></td>
      <td>
        <a th:href="'/buckets/'+${bucketName}+'/'+${folder}+'/'" class="btn btn-info btn-sm mb-3">OPEN</a>
      </td>
    </tr>
    </tbody>
  </table>
  <form id="imageForm" enctype="multipart/form-data">
    <h3> Upload your Image </h3>
    <div class="md-form mb-5 d-flex justify-content-around">
      <i class="fas fa-tag prefix grey-text"></i>
      <div class="w-75">
        <input type="hidden" id="bName" name="bucketName">
        <input type="hidden" id="pName" name="pathName">
        <input type="file" id="image" name="image" class="form-control validate" accept="image/*" required />
        <label data-error="wrong" data-success="right" for="image">Select your Image</label>
      </div>
    </div>
    <div class="text-center mt-4">
      <button class="btn btn-info mt-1" onclick="uploadImage()">Upload<i class="fas fa-sign-in ml-1"></i></button>
    </div>
  </form>
  <div id="imageContainer">
  </div>
</div>
<script th:inline="javascript">
  function createFolder(){
    var form = document.getElementById('folderForm');
    var formData = new FormData(form);
    const bucketName = formData.get("bucketName");
    const jsonObject = {};
    formData.forEach((value, key) => {
      jsonObject[key] = value;
    });
    const jsonPayload = JSON.stringify(jsonObject);
    console.log(jsonPayload)
    fetch('/buckets/'+bucketName+'/folders', {
      method: 'POST',
      headers: {
        "Content-Type": "application/json",
        "X-CSRF-TOKEN":  document.querySelector("meta[name='_csrf']").content
      },
      body: jsonPayload
    })
            .then(response => {
              if (response.ok) {
                location.reload();
              } else {
                console.error('POST request failed with status:', response.status);
              }
            })
            .catch(error => console.error('Error submitting form:', error));
  }
  function uploadImage() {
    var form = document.getElementById('imageForm');
    var formData = new FormData(form);
    const file = formData.get("image");;
    var pathName = formData.get("pathName");
    console.log(pathName," pathhhh")
    paths = window.location.pathname.split('/');
    console.log(paths[2],"bucket nameeee")
    fetch('/buckets/'+paths[2]+'/images', {
      method: 'POST',
      body:formData,
      headers: {
        "X-CSRF-TOKEN":  document.querySelector("meta[name='_csrf']").content
      },
    }).then(response => {
              console.log(response)
              if (response.ok) {
                location.reload();
              } else {
                console.error('POST request failed with status:', response.status);
              }
            })
     .catch(error => console.error('Error submitting form:', error));
  };
    // console.log(jsonPayload,jsonPayload.image ,typeof jsonPayload.image  )
  $(document).ready(function () {
    paths = window.location.pathname.split('/');
    pathname =paths.slice(3,paths.length).join('/');
    $('#bucketName').val(paths[2])
    $('#pathName').val(pathname)
    $('#bName').val(paths[2])
    $('#pName').val(pathname)
    if(pathname != ""){
      url = "/buckets/"+paths[2]+"/images/"+pathname;
    } else {
      url = "/buckets/"+paths[2]+"/images"
    }
    $.get(url, function(imageData) {
      var imageContainer = $("#imageContainer");
      // console.log(imageData)
      imageData.forEach(function(base64Image) {
        var img = $("<img>").attr("src", "data:image/jpeg;base64," + base64Image).addClass("image");
        imageContainer.append(img);
      });
    });
  })
</script>
</body>
</html>